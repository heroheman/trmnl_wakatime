
<!-- import Highcharts + Chartkick libraries -->
<script src="https://code.highcharts.com/highcharts.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartkick@5.0.1/dist/chartkick.min.js"></script>

<!-- Wakatime Dashboard -->
<div class="view view--full">
  <div class="layout layout--col gap--space-between">
    <!-- Key Metrics Grid -->
    <div class="grid grid--cols-3">
      <div class="item">
        <div class="meta"></div>
        <div class="content">
          <span class="value value--tnums">{{ data.0.grand_total.digital | default: "0:00" }}</span>
          <span class="label">Today</span>
        </div>
      </div>
      <div class="item">
        <div class="meta"></div>
        <div class="content">
          {% assign total_hours = 0 %}
          {% for day in data limit: 7 %}
            {% assign total_hours = total_hours | plus: day.grand_total.hours %}
          {% endfor %}
          <span class="value value--tnums">{{ total_hours }}h</span>
          <span class="label">This Week</span>
        </div>
      </div>
      <div class="item">
        <div class="meta"></div>
        <div class="content">
          {% assign avg_hours = 0 %}
          {% assign non_zero_days = 0 %}
          {% for day in data limit: 30 %}
            {% if day.grand_total.hours > 0 %}
              {% assign avg_hours = avg_hours | plus: day.grand_total.hours %}
              {% assign non_zero_days = non_zero_days | plus: 1 %}
            {% endif %}
          {% endfor %}
          {% if non_zero_days > 0 %}
            {% assign avg_hours = avg_hours | divided_by: non_zero_days %}
          {% endif %}
          <span class="value value--tnums">{{ avg_hours }}h</span>
          <span class="label">Daily Avg</span>
        </div>
      </div>
    </div>

    <!-- Chart Container -->
    {% assign selected_layout = trmnl.plugin_settings.custom_fields_values.layout | default: 'lines' | downcase %}
    {% if selected_layout == 'contributions / github style' or selected_layout == 'contributions' %}
      <!-- GitHub-style Contributions Grid -->
      <div class="contributions-container">
        <div class="contributions-grid flex flex--col gap--1" id="contributions-grid-full">
          <!-- Grid will be populated by JavaScript -->
        </div>
        <div class="flex flex--row flex--center-x mt--3">
          <span class="description">Less</span>
          <div class="flex flex--row gap--1 mx--3">
            <div class="w--3 h--3 bg--gray-7"></div>
            <div class="w--3 h--3 bg--gray-5"></div>
            <div class="w--3 h--3 bg--gray-3"></div>
            <div class="w--3 h--3 bg--gray-1"></div>
            <div class="w--3 h--3 bg--black"></div>
          </div>
          <span class="description">More</span>
        </div>
      </div>
    {% else %}
      <div id="wakatime-chart-full" style="width: 100%"></div>
    {% endif %}
  </div>

  <div class="title_bar">
    <img class="image" src="https://wakatime.com/static/img/wakatime-logo.svg" />
    <span class="title">WakaTime</span>
    <span class="instance">Coding Activity</span>
  </div>
</div>

<script type="text/javascript">
  // Prepare chart data from Wakatime API response
  var chartData = [];
  var contributionsData = {};
  
  // Get selected timeframe from settings
  var selectedTimeframe = "{{ trmnl.plugin_settings.custom_fields_values.timeframe | default: 'last_30_days' }}";
  var dataLimit = 365; // Default for contributions and last_year
  
  if (selectedTimeframe === 'last_7_days') {
    dataLimit = 7;
  } else if (selectedTimeframe === 'last_30_days') {
    dataLimit = 30;
  } else if (selectedTimeframe === 'last_90_days') {
    dataLimit = 90;
  }
  
  {% for day in data limit: 365 reversed %}
    {% if day.range.date and day.grand_total.total_seconds %}
      var hours = {{ day.grand_total.total_seconds | divided_by: 3600.0 | round: 2 }};
      chartData.push(["{{ day.range.date }}", hours]);
      contributionsData["{{ day.range.date }}"] = hours;
    {% endif %}
  {% endfor %}

  // Get selected layout from settings
  var selectedLayout = "{{ trmnl.plugin_settings.custom_fields_values.layout | default: 'lines' | downcase }}";
  
  // Filter chart data based on timeframe (but not contributions)
  var filteredChartData = chartData;
  if (selectedLayout !== "contributions / github style" && selectedLayout !== "contributions") {
    filteredChartData = chartData.slice(-dataLimit);
  }

  // Function to get contribution level based on hours
  function getContributionLevel(hours) {
    if (hours === 0) return 'bg--gray-7';
    if (hours < 2) return 'bg--gray-5';
    if (hours < 4) return 'bg--gray-3';
    if (hours < 6) return 'bg--gray-1';
    return 'bg--black';
  }

  // Function to create contributions grid
  function createContributionsGrid() {
    var grid = document.getElementById('contributions-grid-full');
    if (!grid) return;
    
    var today = new Date();
    var startDate = new Date(today);
    startDate.setDate(today.getDate() - 364); // Show last 365 days
    
    // Create weeks container
    var weeksContainer = document.createElement('div');
    weeksContainer.className = 'flex flex--row gap--1 flex--center-x';
    
    // Generate 52 weeks
    for (var week = 0; week < 52; week++) {
      var weekCol = document.createElement('div');
      weekCol.className = 'flex flex--col gap--1';
      
      // Create 7 days for this week
      for (var day = 0; day < 7; day++) {
        var currentDate = new Date(startDate);
        currentDate.setDate(startDate.getDate() + (week * 7) + day);
        
        var daySquare = document.createElement('div');
        daySquare.className = 'w--3 h--3';
        
        var dateStr = currentDate.toISOString().split('T')[0];
        var hours = contributionsData[dateStr] || 0;
        daySquare.className += ' ' + getContributionLevel(hours);
        
        weekCol.appendChild(daySquare);
      }
      
      weeksContainer.appendChild(weekCol);
    }
    
    grid.appendChild(weeksContainer);
  }

  // Function to create chart based on layout selection
  var createChart = function() {
    if (selectedLayout === "contributions / github style" || selectedLayout === "contributions") {
      createContributionsGrid();
    } else if (selectedLayout === "bars") {
      // Create Bar Chart using Chartkick ColumnChart
      new Chartkick["ColumnChart"](
        "wakatime-chart-full",
        filteredChartData,
        {
          adapter: "highcharts",
          prefix: "",
          suffix: "h",
          thousands: ",",
          colors: ["black"],
          library: {
            chart: {
              height: 260
            },
            plotOptions: {
              series: {
                animation: false,
                pointPadding: 0.1,
                groupPadding: 0.1,
                borderWidth: 0
              }
            },
            yAxis: {
              labels: {
                style: {
                  fontSize: "16px",
                  color: "#000000"
                }
              },
              gridLineDashStyle: "shortdot",
              gridLineWidth: 1,
              gridLineColor: "#000000",
              tickAmount: 5,
              title: {
                text: "Hours Coded"
              }
            },
            xAxis: {
              type: "datetime",
              labels: {
                style: {
                  fontSize: "16px",
                  color: "#000000"
                },
                format: '{value:%b %Y}'
              },
              dateTimeLabelFormats: {
                month: '%b %Y',
                year: '%Y'
              },
              tickInterval: 30 * 24 * 3600 * 1000, // Monthly intervals (30 days in milliseconds)
              lineWidth: 0,
              gridLineDashStyle: "dot",
              tickWidth: 1,
              tickLength: 0,
              gridLineWidth: 1,
              gridLineColor: "#000000"
            }
          }
        }
      );
    } else {
      // Create Line Chart (default)
      new Chartkick["LineChart"](
        "wakatime-chart-full",
        filteredChartData,
        {
          adapter: "highcharts",
          prefix: "",
          suffix: "h",
          thousands: ",",
          points: false,
          colors: ["black"],
          curve: true,
          library: {
            chart: {
              height: 260
            },
            plotOptions: {
              series: {
                animation: false,
                lineWidth: 4
              }
            },
            yAxis: {
              labels: {
                style: {
                  fontSize: "16px",
                  color:"#000000"
                }
              },
              gridLineDashStyle: "shortdot",
              gridLineWidth: 1,
              gridLineColor: "#000000",
              tickAmount: 5,
              title: {
                text: "Hours Coded"
              }
            },
            xAxis: {
              type: "datetime",
              labels: {
                style: {
                  fontSize: "16px",
                  color: "#000000"
                }
              },
              lineWidth: 0,
              gridLineDashStyle: "dot",
              tickWidth: 1,
              tickLength: 0,
              gridLineWidth: 1,
              gridLineColor: "#000000",
              tickPixelInterval: 120
            }
          }
        }
      );
    }
  };

  // ensure your chart loads before plugin render is generated
  if (selectedLayout === "contributions / github style" || selectedLayout === "contributions") {
    createChart();
  } else if ("Chartkick" in window) {
    createChart();
  } else {
    window.addEventListener("chartkick:load", createChart, true);
  }
</script>