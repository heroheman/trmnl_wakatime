<style>
.year {
    --gap: 4px;
}
.week {
    display: flex;
    flex-direction: column;
    gap: 0.25rem !important; 
    --gap: 10px;
}

.day {
    width: 11px;
    height: 11px;
    border-radius: 0.125rem;
    flex-shrink: 0;
}
</style>    


<!-- Shared WakaTime JavaScript Functions -->
<script src="https://code.highcharts.com/highcharts.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartkick@5.0.1/dist/chartkick.min.js"></script>

{% template calculate_hours %}
    {% assign total_decimal = 0 %}
    {% assign decimal_strings = "" %}
    {% assign data = data | reverse %}
    
    {% comment %} Iterate through the data for the specified limit {% endcomment %}
    {% for day in data limit: limit %}
        {% assign day_decimal = day.grand_total.decimal | plus: 0 %}
        {% comment %} Add to total decimal time {% endcomment %}
        {% assign decimal_strings = decimal_strings | append: day_decimal | append: ',' %}
        {% assign total_decimal = total_decimal | plus: day_decimal %}
    {% endfor %}
    {% comment %} Format time with 15-minute rounding {% endcomment %}
    {% assign total_minutes = total_decimal | times: 60 | round %}
    {% assign remainder = total_minutes | modulo: 15 %}
    {% if remainder > 0 %}
        {% assign total_minutes = total_minutes | plus: 15 | minus: remainder %}
    {% endif %}
    {% assign display_hours = total_minutes | divided_by: 60 %}
    {% assign display_minutes = total_minutes | modulo: 60 %}
    {% if display_minutes == 0 %}
        {% assign formatted_time = display_hours | append: 'h' %}
    {% elsif display_minutes < 10 %}
        {% assign formatted_time = display_hours | append: 'h0' | append: display_minutes | append: 'm' %}
    {% else %}
        {% assign formatted_time = display_hours | append: 'h' | append: display_minutes| append: 'm' %}
    {% endif %}
    {% comment %} <span class="value value--tnums {{valueSize}}" data-value-fit="{{ valueFit }}">{{ decimal_strings }}</span> {% endcomment %}
    <span class="value value--tnums {{valueSize}}" data-value-fit="{{ valueFit }}">{{ formatted_time }}</span>
{% endtemplate %}

{% template contributions_grid %}
  <div class="contributions-container">
    <!-- Generate contributions grid in Liquid -->
    <div class="flex flex--row flex--center-x year">
      
      {% comment %} Simple approach: just render squares for the data we have {% endcomment %}
      {% assign days_rendered = 0 %}
      {% assign current_week_days = 0 %}
      
      {% for day in data limit: 364 reversed %}
        {% if day.range.date and day.grand_total.total_seconds %}
          {% assign hours = day.grand_total.total_seconds | divided_by: 3600.0 | round: 2 %}
          
          {% comment %} Start a new week column when needed {% endcomment %}
          {% if current_week_days == 0 %}
            <div class="flex flex--col week gap--0">
          {% endif %}
          
          {% comment %} Determine background class based on hours {% endcomment %}
          {% assign bg_class = 'bg--gray-7' %}
          {% if hours > 0 %}
            {% if hours < 1 %}
              {% assign bg_class = 'bg--gray-6' %}
            {% elsif hours < 2 %}
              {% assign bg_class = 'bg--gray-4' %}
            {% elsif hours < 3 %}
              {% assign bg_class = 'bg--gray-3' %}
            {% elsif hours < 4 %}
              {% assign bg_class = 'bg--gray-2' %}
            {% elsif hours < 5 %}
              {% assign bg_class = 'bg--gray-1' %}
            {% else %}
              {% assign bg_class = 'bg--black' %}
            {% endif %}
          {% endif %}
          
          <div class="day {{ bg_class }}"></div>
          
          {% assign current_week_days = current_week_days | plus: 1 %}
          {% assign days_rendered = days_rendered | plus: 1 %}
          
          {% comment %} Close week column after 7 days {% endcomment %}
          {% if current_week_days == 7 %}
            </div>
            {% assign current_week_days = 0 %}
          {% endif %}
        {% endif %}
      {% endfor %}
      
      {% comment %} Close any remaining open week div {% endcomment %}
      {% if current_week_days > 0 %}
        </div>
      {% endif %}
      
    </div>
    
    <div class="flex flex--row flex--start-x mt--3">
      <span class="description">Less</span>
      <div class="flex flex--row gap--1 mx--3">
        <div class="w--3 h--3 bg--gray-7"></div>
        <div class="w--3 h--3 bg--gray-5"></div>
        <div class="w--3 h--3 bg--gray-3"></div>
        <div class="w--3 h--3 bg--gray-2"></div>
        <div class="w--3 h--3 bg--gray-1"></div>
        <div class="w--3 h--3 bg--black"></div>
      </div>
      <span class="description">More</span>
    </div>
  </div>
{% endtemplate %}


{% template dashboard_horizontal %}
    <!-- Key Metrics Grid -->
    {% assign metrics_array = selected_metrics | split: ',' %}
    {% assign metrics_count = metrics_array.size %}
    {% assign valueSize = '' %}

    {% if metrics_count > 0 %}
      {% if metrics_count == 1 %}
        {% assign grid_class = "grid grid--cols-1" %}
      {% elsif metrics_count == 2 %}
        {% assign grid_class = "grid grid--cols-2" %}
      {% elsif metrics_count == 3 %}
        {% assign grid_class = "grid grid--cols-3" %}
      {% elsif metrics_count == 4 %}
        {% assign grid_class = "grid grid--cols-4" %}
      {% else %}
        {% assign valueFit = true %}
        {% assign valueSize = 'value--small' %}

        {% assign grid_class = "grid grid--cols-5" %}
      {% endif %}
      
      <div class="{{ grid_class }}">
        {% for metric in metrics_array %}
          {% assign metric_trimmed = metric | strip %}
          <div class="item">
            <div class="meta"></div>
            <div class="content">
              {% if metric_trimmed == 'today' %}
                {% render 'calculate_hours' data: data, limit: 1, valueFit: valueFit, valueSize: valueSize %}
                <span class="label">Today</span>
              {% elsif metric_trimmed == 'this_week' %}
                {% render 'calculate_hours' data: data, limit: 7, valueFit: valueFit, valueSize: valueSize %}
                <span class="label">This Week</span>
              {% elsif metric_trimmed == 'this_month' %}
                {% render 'calculate_hours' data: data, limit: 30, valueFit: valueFit, valueSize: valueSize %}
                <span class="label">This Month</span>
              {% elsif metric_trimmed == 'last_3_months' %}
                {% render 'calculate_hours' data: data, limit: 90, valueFit: valueFit, valueSize: valueSize %}
                <span class="label">Last 3 Months</span>
              {% elsif metric_trimmed == 'last_year' %}
                {% render 'calculate_hours' data: data, limit: 365, valueFit: valueFit, valueSize: valueSize %}
                <span class="label">Last Year</span>
              {% endif %}
            </div>
          </div>
        {% endfor %}
      </div>
    {% endif %}
{% endtemplate %}


{% template wakatime_charts %}
    <div id="wakatime-chart-full" style="width: 100%"></div>
    <script type="text/javascript">
    // Prepare chart data from Wakatime API response
    var chartData = [];
    var contributionsData = {};
    var chartHeight = {{ chart_height | default: 260 }};
    var showXAxisLabels = "{{ show_x_axis_labels | default: 'true' }}" === 'true';
    console.log("showXAxisLabels:", showXAxisLabels);
    
    // Get selected timeframe from settings
    var selectedTimeframe = "{{ selected_timeframe |  default: 'last_30_days' }}";
    var dataLimit = 365; // Default for contributions and last_year
    
    if (selectedTimeframe === 'last_7_days') {
        dataLimit = 7;
    } else if (selectedTimeframe === 'last_30_days') {
        dataLimit = 30;
    } else if (selectedTimeframe === 'last_90_days') {
        dataLimit = 90;
    }
    
    {% for day in data limit: 365 reversed %}
        {% if day.range.date and day.grand_total.total_seconds %}
        {% assign day_start_date = day.range.date %}
        {% comment %} Use date directly for consistency with JavaScript Date object {% endcomment %}
        var hours = {{ day.grand_total.total_seconds | divided_by: 3600.0 | round: 2 }};
        chartData.push(["{{ day_start_date }}", hours]);
        contributionsData["{{ day_start_date }}"] = hours;
        {% endif %}
    {% endfor %}

    // Get selected layout from settings
    var selectedLayout = "{{ selected_layout | default: 'lines' }}";
    
    // Get grouping setting
    var enableGrouping = "{{ enable_grouping | default: 'true' }}" === 'true';
    
    // Filter chart data based on timeframe (but not contributions)
    var filteredChartData = chartData;
    if (selectedLayout !== "contributions") {
        filteredChartData = chartData.slice(-dataLimit);
    }

    // Function to group data for line charts
    function groupDataForLineChart(data, timeframe) {
        // Only group if grouping is enabled
        if (!enableGrouping) {
        return data;
        }
        
        if (timeframe === 'last_90_days') {
        // Group by 7-day periods and calculate median
        var groupedData = [];
        for (var i = 0; i < data.length; i += 7) {
            var weekData = data.slice(i, i + 7);
            if (weekData.length > 0) {
            var values = weekData.map(function(item) { return item[1]; }).sort(function(a, b) { return a - b; });
            var median = values.length % 2 === 0 
                ? (values[Math.floor(values.length / 2) - 1] + values[Math.floor(values.length / 2)]) / 2
                : values[Math.floor(values.length / 2)];
            // Use the last date of the week
            groupedData.push([weekData[weekData.length - 1][0], median]);
            }
        }
        return groupedData;
        } else if (timeframe === 'last_year') {
        // Group by month and calculate median
        var monthlyGroups = {};
        data.forEach(function(item) {
            var date = new Date(item[0]);
            var monthKey = date.getFullYear() + '-' + String(date.getMonth() + 1).padStart(2, '0');
            if (!monthlyGroups[monthKey]) {
            monthlyGroups[monthKey] = [];
            }
            monthlyGroups[monthKey].push(item[1]);
        });
        
        var groupedData = [];
        Object.keys(monthlyGroups).sort().forEach(function(monthKey) {
            var values = monthlyGroups[monthKey].sort(function(a, b) { return a - b; });
            var median = values.length % 2 === 0 
            ? (values[Math.floor(values.length / 2) - 1] + values[Math.floor(values.length / 2)]) / 2
            : values[Math.floor(values.length / 2)];
            // Use first day of month for consistent display
            groupedData.push([monthKey + '-01', median]);
        });
        return groupedData;
        }
        return data;
    }

    // Function to get X-axis configuration based on timeframe
    function getXAxisConfig(timeframe, showXAxisLabels) {
        console.log("getXAxisConfig called with timeframe:", timeframe, "showXAxisLabels:", showXAxisLabels);
        var config = {
            type: "datetime",
            labels: {
                style: {
                    fontSize: "14px",
                    color: "#000000"
                }
            },
            gridLineDashStyle: "dot",
            tickWidth: 1,
            tickLength: 0,
            gridLineWidth: 1,
            gridLineColor: "#000000"
        };

        if (showXAxisLabels) {
            config.labels.enabled = true;
            
            if (timeframe === 'last_7_days') {
                // Show day names for 7 days
                config.labels.format = '{value:%a}';
                config.tickPixelInterval = 50;
            } else if (timeframe === 'last_30_days') {
                // Show dates for 30 days
                config.labels.format = '{value:%d.%m}';
                config.tickPixelInterval = 80;
            } else if (timeframe === 'last_90_days') {
                config.labels.format = '{value:%d.%m}';
                config.tickPixelInterval = 120;
                // Don't set tickInterval, let Highcharts decide
            } else if (timeframe === 'last_year') {
                // Show month names for year
                config.labels.format = '{value:%b}';
                config.tickPixelInterval = 120;
                // Don't set tickInterval, let Highcharts decide
            }
        } else {
            config.labels.enabled = false;
        }
        
        return config;
    }

    // Function to create chart based on layout selection
    var createChart = function(showXAxisLabels) {
        var xAxisConfig = getXAxisConfig(selectedTimeframe, showXAxisLabels);
        
        if (selectedLayout === "contributions") {
        // Contributions are now rendered in Liquid template
        return;
        } else if (selectedLayout === "bars") {
        // Create Bar Chart using Chartkick ColumnChart
        new Chartkick["ColumnChart"](
            "wakatime-chart-full",
            filteredChartData,
            {
            adapter: "highcharts",
            prefix: "",
            suffix: "h",
            thousands: ",",
            colors: ["black"],
            tooltip: false,
            library: {
                chart: {
                height: chartHeight
                },
                plotOptions: {
                series: {
                    animation: false,
                    pointPadding: 0.1,
                    groupPadding: 0.1,
                    borderWidth: 0
                }
                },
                yAxis: {
                labels: {
                    style: {
                    fontSize: "16px",
                    color: "#000000"
                    }
                },
                gridLineDashStyle: "shortdot",
                gridLineWidth: 1,
                gridLineColor: "#000000",
                tickAmount: 5,
                title: {
                    text: "Hours Coded"
                }
                },
                xAxis: xAxisConfig
            }
            }
        );
        } else {
        // Create Line Chart (default) with data grouping
        var lineChartData = groupDataForLineChart(filteredChartData, selectedTimeframe);
        new Chartkick["LineChart"](
            "wakatime-chart-full",
            lineChartData,
            {
            adapter: "highcharts",
            prefix: "",
            suffix: "h",
            thousands: ",",
            points: false,
            colors: ["black"],
            curve: true,
            tooltip: false,
            library: {
                chart: {
                height: chartHeight
                },
                plotOptions: {
                series: {
                    animation: false,
                    lineWidth: 4
                }
                },
                yAxis: {
                labels: {
                    style: {
                    fontSize: "16px",
                    color:"#000000"
                    }
                },
                gridLineDashStyle: "shortdot",
                gridLineWidth: 1,
                gridLineColor: "#000000",
                tickAmount: 5,
                title: {
                    text: "Hours Coded"
                }
                },
                xAxis: xAxisConfig
            }
            }
        );
        }
    };

    // ensure your chart loads before plugin render is generated
    if (selectedLayout === "contributions") {
        // Contributions are now rendered in Liquid template - no JavaScript needed
    } else if ("Chartkick" in window) {
        createChart(showXAxisLabels);
    } else {
        window.addEventListener("chartkick:load", createChart, true);
    }
    </script>
{% endtemplate %}

{% template wakatime_title_bar %}
  <div class="title_bar">
    <img class="image" src="https://wakatime.com/static/img/wakatime-logo.svg" />
    <span class="title">WakaTime</span>
    <span class="instance">Coding Activity</span>
  </div>
{% endtemplate %}
